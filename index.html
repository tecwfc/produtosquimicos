<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Pedidos ‚Äî GLGA (Carrinho E-commerce)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { inter: ['Inter', 'sans-serif'] },
                    colors: { primary: '#16a34a', accent: '#10b981', softgreen: '#e8fbea' },
                    boxShadow: { 'soft-lg': '0 10px 30px rgba(16,24,40,0.08)' }
                }
            }
        }
    </script>

    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-bg-dark: rgba(17, 24, 39, 0.55);
            --glass-border-dark: rgba(255, 255, 255, 0.06);
        }

        body {
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background: radial-gradient(circle at 10% 20%, #e9fff0, #d6f7e3 20%, #eafaf0 60%);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px) saturate(120%);
            -webkit-backdrop-filter: blur(12px) saturate(120%);
            border: 1px solid var(--glass-border);
        }

        .glass-dark {
            background: var(--glass-bg-dark);
            backdrop-filter: blur(12px) saturate(120%);
            -webkit-backdrop-filter: blur(12px) saturate(120%);
            border: 1px solid var(--glass-border-dark);
        }

        @media (max-width: 640px) {
            body {
                background: linear-gradient(180deg, #f6fff6, #f0f9ee);
            }
        }

        .focus-ring:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(10, 185, 129, 0.12);
            border-color: var(--tw-ring-color);
        }

        .product-row {
            transition: background .12s, transform .12s, box-shadow .12s;
        }

        .product-row:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px -1px rgb(0 0 0 / 0.05), 0 1px 2px -1px rgb(0 0 0 / 0.05);
        }

        /* Estilo para inputs de quantidade (E-commerce look) */
        .qty-input {
            transition: background .12s, border-color .12s;
            width: 50px;
            text-align: center;
            font-size: 0.875rem;
            padding: 0.5rem 0.25rem;
            height: 32px;
            border: 1px solid #d1d5db;
        }

        .qty-error {
            border-color: #dc2626 !important;
            background: #fff5f5 !important;
        }

        .qty-btn-minus,
        .qty-btn-plus {
            border: 1px solid #d1d5db;
        }

        .qty-btn-minus {
            border-right: none;
        }

        .qty-btn-plus {
            border-left: none;
        }

        .skeleton {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.06) 25%, rgba(255, 255, 255, 0.12) 50%, rgba(255, 255, 255, 0.06) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.2s linear infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>

<body class="min-h-screen">

    <header id="mainHeader" class="fixed top-4 left-1/2 -translate-x-1/2 w-[min(1100px,96%)] z-50">
        <div class="glass rounded-3xl px-4 py-3 flex items-center justify-between shadow-soft-lg">

            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 rounded-xl bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white shadow">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 3h18v4H3zM5 11h14v10H5z" />
                    </svg>
                </div>
                <div>
                    <div class="text-sm text-gray-700 font-semibold">Ivo Pita - Pedido GLGA</div>
                    <div class="text-xs text-gray-500">Controle de Pedidos</div>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button id="themeToggle" title="Alternar tema" class="p-2 rounded-lg hover:bg-white/30 transition">
                    <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-green-700"
                        viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 3v2M12 19v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42M12 7a5 5 0 100 10 5 5 0 000-10z" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main class="pt-28 pb-24 flex justify-center">
        <div class="w-[min(1100px,96%)]">

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <section class="col-span-1 lg:col-span-1 space-y-6">

                    <div class="glass rounded-2xl p-6 shadow-lg">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">üõí Selecionar Produtos</h2>

                        <div class="mb-5">
                            <label class="text-sm font-semibold text-gray-700">üìÖ Data do Pedido</label>
                            <input id="orderDate" type="date"
                                class="w-full mt-1 px-4 py-3 rounded-xl border border-gray-200 focus-ring bg-white/70"
                                required />
                        </div>

                        <div id="formSkeleton" class="space-y-3">
                            <div class="h-10 rounded-lg skeleton"></div>
                            <div class="h-10 rounded-lg skeleton"></div>
                            <div class="h-10 rounded-lg skeleton"></div>
                            <div class="h-12 rounded-xl skeleton"></div>
                        </div>

                        <div id="productSelectionSection" class="hidden grid grid-cols-1 gap-4">
                            <label class="text-sm font-semibold text-gray-700 mt-2">Clique em (+) para adicionar 1
                                unidade no carrinho.</label>

                            <div id="productList"
                                class="max-h-72 overflow-y-auto border border-gray-100 rounded-lg p-2 bg-white/60">
                            </div>

                            <div id="messageBox" class="mt-3 text-sm hidden p-3 rounded-lg"></div>
                        </div>
                    </div>

                    <div class="glass rounded-2xl p-6 shadow-lg">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center justify-between">
                            <span>üì¶ Itens Pendentes (Carrinho)</span>
                            <span id="cartCount" class="text-sm font-medium text-green-600">0 itens</span>
                        </h2>

                        <div id="cartContainer" class="mt-4 overflow-x-auto">
                            <div id="noCartItems" class="text-center text-gray-500 py-4 text-sm">Nenhum item no
                                carrinho.</div>
                        </div>

                        <div id="cartSummary" class="mt-4 pt-4 border-t border-gray-100 hidden">
                            <div class="flex justify-between font-semibold text-gray-700 mb-2">
                                <span class="text-sm">Total de Itens Diferentes:</span>
                                <span id="cartTotalItems" class="text-green-700">0</span>
                            </div>

                            <div class="flex justify-between font-bold text-gray-800 mb-4">
                                <span class="text-base">TOTAL GERAL (Qtd/Peso):</span>
                                <span id="cartTotalQuantity" class="text-xl text-primary">0,00</span>
                            </div>

                            <button id="finalizeOrderBtn" type="button"
                                class="mt-4 w-full px-4 py-3 rounded-xl bg-gradient-to-br from-green-500 to-green-600 text-white font-semibold shadow hover:scale-[1.01] transition">
                                ‚úÖ Finalizar Pedido e Registrar
                            </button>

                            <button id="clearCartBtn" type="button"
                                class="mt-2 w-full px-4 py-2 rounded-xl bg-red-100 text-red-600 font-medium hover:bg-red-200 transition">
                                Limpar Carrinho
                            </button>
                        </div>
                    </div>

                    <div class="glass rounded-2xl p-4 shadow-md">
                        <h3 class="text-sm font-semibold text-gray-700">A√ß√µes</h3>
                        <div class="flex gap-2 mt-3">
                            <button id="btnExportPDF"
                                class="w-full px-3 py-2 bg-green-600 text-white rounded-lg">Exportar PDF
                                (Hist√≥rico)</button>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button id="btnClearAll" class="w-full px-3 py-2 bg-red-100 text-red-700 rounded-lg">Limpar
                                TODOS Pedidos Registrados</button>
                        </div>
                    </div>
                </section>

                <section class="col-span-1 lg:col-span-2">
                    <div class="glass rounded-2xl p-4 shadow-lg">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-bold text-gray-800">üìã Pedidos Registrados</h2>
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-600 hidden sm:block">Ordenar:</label>
                                <select id="sortSelect" class="px-3 py-2 rounded-lg border border-gray-200 bg-white/70">
                                    <option value="new">Mais recentes</option>
                                    <option value="old">Mais antigos</option>
                                </select>
                            </div>
                        </div>

                        <div id="ordersContainer" class="mt-4 space-y-3 min-h-[220px]">
                            <div id="noOrders" class="text-center text-gray-500 py-12">Nenhum pedido registrado ainda.
                            </div>
                        </div>

                        <div class="mt-4 flex items-center justify-between">
                            <div id="countInfo" class="text-sm text-gray-600">0 pedidos</div>
                            <div class="flex items-center gap-2">
                                <button id="openFilters"
                                    class="px-3 py-2 rounded-lg bg-white/60 hidden">Filtrar</button>
                            </div>
                        </div>
                    </div>

                    <div id="detailsPanel" class="mt-4 glass rounded-2xl p-4 shadow-lg hidden"></div>
                </section>
            </div>
        </div>
    </main>

    <div id="pdfContent" class="hidden p-6 max-w-3xl mx-auto glass">
        <h1 class="text-xl font-bold text-center text-primary">Pedido GLGA - Ivo Pita Ind√∫stria</h1>
        <p id="reportDate" class="text-center text-sm text-gray-600 mb-4"></p>
        <table class="w-full text-sm border-collapse">
            <thead class="bg-green-600 text-white">
                <tr>
                    <th class="p-2 border">Data</th>
                    <th class="p-2 border">Descri√ß√£o</th>
                    <th class="p-2 border text-center">Quantidade</th>
                    <th class="p-2 border">Tipo</th>
                </tr>
            </thead>
            <tbody id="pdfTableBody"></tbody>
        </table>
    </div>

    <script src="https://raw.githack.com/eKoopmans/html2pdf/master/dist/html2pdf.bundle.js"></script>

    <script>
        // ---------- CONFIG & ELEMENTS ----------
        // Substitua pela sua URL real do Google Apps Script
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzHzCiHTdfZMbQXOZzoDrWKxkzutGcaZ1j-gFEaeqmw1pm8geKI50zzYRdwwhASswsjWQ/exec';

        const orderDate = document.getElementById('orderDate');
        const messageBox = document.getElementById('messageBox');
        const ordersContainer = document.getElementById('ordersContainer');
        const noOrders = document.getElementById('noOrders');
        const formSkeleton = document.getElementById('formSkeleton');
        const productSelectionSection = document.getElementById('productSelectionSection');
        const productListEl = document.getElementById('productList');
        const sortSelect = document.getElementById('sortSelect');
        const countInfo = document.getElementById('countInfo');

        const cartContainer = document.getElementById('cartContainer');
        const noCartItems = document.getElementById('noCartItems');
        const cartCount = document.getElementById('cartCount');
        const cartSummary = document.getElementById('cartSummary');
        const cartTotalItems = document.getElementById('cartTotalItems');
        const cartTotalQuantity = document.getElementById('cartTotalQuantity'); // NOVO
        const finalizeOrderBtn = document.getElementById('finalizeOrderBtn');
        const btnExportPDF = document.getElementById('btnExportPDF');
        const clearCartBtn = document.getElementById('clearCartBtn'); // NOVO

        // Elementos do PDF
        const pdfContent = document.getElementById('pdfContent');
        const pdfTableBody = document.getElementById('pdfTableBody');
        const reportDate = document.getElementById('reportDate');

        let products = []; // Lista de produtos dispon√≠veis (API/Sheet)
        let orders = [];   // Pedidos J√Å REGISTRADOS (LocalStorage)
        let cart = [];     // Itens NO CARRINHO/PENDENTES (In-Memory)

        orderDate.value = new Date().toISOString().split('T')[0];

        // --- Theme Toggling (Mantido o seu c√≥digo original para o tema) ---
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const bodyEl = document.body;

        function applyTheme(theme) {
            if (theme === 'dark') {
                bodyEl.classList.add('dark');
                document.documentElement.style.setProperty('--glass-bg', 'rgba(17,24,39,0.55)');
                document.documentElement.style.setProperty('--glass-border', 'rgba(255,255,255,0.06)');
                themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>';
            } else {
                bodyEl.classList.remove('dark');
                document.documentElement.style.setProperty('--glass-bg', 'rgba(255,255,255,0.7)');
                document.documentElement.style.setProperty('--glass-border', 'rgba(255,255,255,0.5)');
                themeIcon.innerHTML = '<path d="M12 3v2M12 19v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42M12 7a5 5 0 100 10 5 5 0 000-10z"/>';
            }
            localStorage.setItem('ui-theme', theme);
        }

        (function initTheme() {
            const saved = localStorage.getItem('ui-theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(saved);
            themeToggle.addEventListener('click', () => {
                const next = (localStorage.getItem('ui-theme') === 'dark') ? 'light' : 'dark';
                applyTheme(next);
            });
        })();

        // ---------- UTIL ----------
        function showMsg(text, type = 'success') {
            messageBox.textContent = text;
            messageBox.className = 'mt-3 p-3 rounded-lg text-sm';
            if (type === 'success') { messageBox.classList.add('bg-green-50', 'text-green-700'); }
            else if (type === 'error') { messageBox.classList.add('bg-red-50', 'text-red-700'); }
            else { messageBox.classList.add('bg-yellow-50', 'text-yellow-700'); }
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 3500);
        }

        function escapeAttr(s) { return String(s || '').replaceAll('"', '&quot;').replaceAll("'", '&#39;'); }
        function escapeHtml(s) { return String(s).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;'); }
        function formatDate(iso) { try { const [y, m, d] = iso.split('-'); return `${d}/${m}/${y}`; } catch { return iso; } }

        function formatNumberToLocal(num) {
            return (Number(num) || 0).toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function normalizeQuantityInput(value) {
            const cleaned = String(value).replace(',', '.').trim();
            const num = parseFloat(cleaned);
            // Aceita 0, mas NaN ou negativo n√£o
            return (num >= 0 && !isNaN(num)) ? num : NaN;
        }

        // ---------- PRODUCT LIST RENDER & LOGIC ----------
        function populateProductList() {
            productListEl.innerHTML = '';

            if (!products || products.length === 0) {
                productListEl.innerHTML = '<div class="text-sm text-gray-500 p-2">Nenhum produto dispon√≠vel para sele√ß√£o.</div>';
                return;
            }

            products.forEach((p, index) => {
                const row = document.createElement('div');
                const cartItem = cart.find(item => item.description === p.description);
                const currentQty = cartItem ? formatNumberToLocal(cartItem.quantity) : '0,00';
                const isSelectedClass = cartItem ? 'border-green-300 bg-green-50' : 'border-gray-200 bg-white/70';

                row.className = `product-row flex items-center justify-between gap-3 p-3 rounded-xl border mb-2 cursor-pointer ${isSelectedClass}`;
                row.dataset.index = index;

                row.innerHTML = `
                    <div class="flex-1">
                        <div class="font-medium text-sm">${escapeHtml(p.description)}</div>
                        <div class="text-xs text-gray-500">${p.type ? 'Tipo: ' + escapeHtml(p.type) : ''}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="qtyIndicator-${index}" class="text-xs font-bold w-12 text-right ${cartItem ? 'text-green-700' : 'text-gray-500'}">${currentQty}</span>
                        
                        <button class="add-to-cart-btn p-2 rounded-full bg-green-500 text-white hover:bg-green-600 transition w-8 h-8 flex items-center justify-center text-lg leading-none" 
                            data-desc="${escapeAttr(p.description)}"
                            data-type="${escapeAttr(p.type || '')}"
                            title="Adicionar 1 unidade">
                            +
                        </button>
                    </div>
                `;

                row.querySelector('.add-to-cart-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const desc = e.currentTarget.dataset.desc;
                    const type = e.currentTarget.dataset.type;
                    addToCart(desc, type, 1);
                });

                productListEl.appendChild(row);
            });
        }

        // ---------- FETCH PRODUCTS (Mantido) ----------
        async function fetchProducts() {
            formSkeleton.classList.remove('hidden');
            productSelectionSection.classList.add('hidden');
            productListEl.innerHTML = '<div class="text-sm text-gray-500 p-2">Carregando produtos...</div>';

            try {
                const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getProducts&t=${Date.now()}`);
                if (!res.ok) { throw new Error(`Erro de rede: ${res.status} ${res.statusText}`); }

                const data = await res.json();

                if (data?.status === 'success' && Array.isArray(data.products)) {
                    products = data.products;
                } else {
                    throw new Error(data?.message || 'Resposta do Sheets inv√°lida ou vazia.');
                }
            } catch (err) {
                console.error('Erro fatal ao buscar produtos:', err);
                products = [];
                productListEl.innerHTML = `<div class="text-sm text-red-600 p-2">‚ùå Erro ao carregar: ${err.message || 'Verifique a URL do Google Sheets.'}</div>`;
            } finally {
                formSkeleton.classList.add('hidden');
                productSelectionSection.classList.remove('hidden');
                populateProductList();
            }
        }

        // ---------- CART LOGIC (Atualizado com c√°lculo do total) ----------
        function renderCart() {
            cartContainer.innerHTML = '';
            cartCount.textContent = `${cart.length} item(ns)`;
            cartTotalItems.textContent = cart.length;

            const totalQuantity = cart.reduce((sum, item) => sum + (item.quantity || 0), 0);
            cartTotalQuantity.textContent = formatNumberToLocal(totalQuantity);

            if (!cart.length) {
                noCartItems.classList.remove('hidden');
                cartSummary.classList.add('hidden');
                return;
            }

            noCartItems.classList.add('hidden');
            cartSummary.classList.remove('hidden');

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/2">Produto</th>
                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Quantidade</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">A√ß√£o</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200"></tbody>
            `;
            const tbody = table.querySelector('tbody');

            cart.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'cart-item bg-white';

                // Adiciona classe de erro se a quantidade for menor ou igual a zero (para dar feedback visual)
                const errorClass = (item.quantity <= 0) ? 'qty-error' : '';

                tr.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${escapeHtml(item.description)}</div>
                        <div class="text-xs text-gray-500">${item.type ? escapeHtml(item.type) : ''}</div>
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-center">
                        <div class="flex items-center justify-center">
                            <button class="qty-btn-minus p-1 bg-red-50 text-red-600 rounded-l hover:bg-red-100 transition w-7 h-7 flex items-center justify-center text-base leading-none" data-index="${index}">-</button>
                            <input type="text" value="${formatNumberToLocal(item.quantity)}" 
                                class="qty-input border border-gray-300 focus-ring ${errorClass}"
                                data-index="${index}"
                                inputmode="decimal" />
                            <button class="qty-btn-plus p-1 bg-green-50 text-green-600 rounded-r hover:bg-green-100 transition w-7 h-7 flex items-center justify-center text-base leading-none" data-index="${index}">+</button>
                        </div>
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-right">
                        <button class="remove-cart-btn text-red-600 hover:text-red-900 text-sm" data-index="${index}">
                            Remover
                        </button>
                    </td>
                `;

                const qtyInput = tr.querySelector('.qty-input');
                const btnMinus = tr.querySelector('.qty-btn-minus');
                const btnPlus = tr.querySelector('.qty-btn-plus');
                const btnRemove = tr.querySelector('.remove-cart-btn');

                const updateCartAndIndicators = () => {
                    renderCart();
                    updateProductIndicators();
                };

                btnPlus.addEventListener('click', () => { cart[index].quantity += 1; updateCartAndIndicators(); });
                btnMinus.addEventListener('click', () => {
                    if (cart[index].quantity > 0.01) { cart[index].quantity = Math.max(0, cart[index].quantity - 1); updateCartAndIndicators(); }
                    else { cart.splice(index, 1); updateCartAndIndicators(); }
                });

                qtyInput.addEventListener('input', (e) => {
                    const normalizedQty = normalizeQuantityInput(e.target.value);
                    if (isNaN(normalizedQty) || normalizedQty < 0) { qtyInput.classList.add('qty-error'); }
                    else { qtyInput.classList.remove('qty-error'); cart[index].quantity = normalizedQty; }
                });

                qtyInput.addEventListener('blur', (e) => {
                    const normalizedQty = normalizeQuantityInput(e.target.value);
                    if (isNaN(normalizedQty) || normalizedQty <= 0) { cart.splice(index, 1); updateCartAndIndicators(); }
                    else { e.target.value = formatNumberToLocal(normalizedQty); cart[index].quantity = normalizedQty; updateCartAndIndicators(); }
                });

                btnRemove.addEventListener('click', () => { cart.splice(index, 1); updateCartAndIndicators(); });

                tbody.appendChild(tr);
            });

            cartContainer.appendChild(table);
        }

        function addToCart(desc, type, qty = 1) {
            const index = cart.findIndex(item => item.description === desc);
            if (index !== -1) {
                cart[index].quantity = (cart[index].quantity || 0) + qty;
                showMsg(`Adicionado +${formatNumberToLocal(qty)} de ${desc}.`, 'info');
            } else {
                cart.push({ description: desc, type: type || '', quantity: qty });
                showMsg(`${desc} adicionado ao carrinho.`, 'success');
            }
            cart.sort((a, b) => a.description.localeCompare(b.description));
            renderCart();
            updateProductIndicators();
        }

        function updateProductIndicators() {
            document.querySelectorAll('#productList .product-row').forEach(row => {
                const productEl = row.querySelector('.add-to-cart-btn');
                if (!productEl) return;
                const desc = productEl.dataset.desc;
                const cartItem = cart.find(item => item.description === desc);
                const indicator = row.querySelector(`#qtyIndicator-${row.dataset.index}`);

                if (indicator) {
                    const qty = cartItem ? cartItem.quantity : 0;
                    indicator.textContent = formatNumberToLocal(qty);
                    indicator.classList.toggle('text-green-700', qty > 0);
                    indicator.classList.toggle('text-gray-500', qty === 0);
                    row.classList.toggle('border-green-300', qty > 0);
                    row.classList.toggle('bg-green-50', qty > 0);
                    row.classList.toggle('bg-white/70', qty === 0);
                }
            });
        }

        // ---------- FUN√á√ÉO DE GERA√á√ÉO DE PDF (Mantida a centraliza√ß√£o) ----------
        function generatePDF() {
            if (!orders.length) {
                showMsg('Nenhum pedido registrado para gerar o PDF.', 'error');
                return;
            }

            pdfTableBody.innerHTML = '';

            // üëâ TOTAL DE ITENS + TOTAL DE QUANTIDADE
            const totalItens = orders.length;
            const totalQuantidade = orders.reduce((sum, o) => sum + (o.quantity || 0), 0);

            // üëâ MONTAR A TABELA DO PDF
            orders.forEach(o => {
                const formattedQuantity = formatNumberToLocal(o.quantity);

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-softgreen';
                tr.innerHTML = `
            <td class="p-2 border text-center">${formatDate(o.date)}</td>
            <td class="p-2 border">${escapeHtml(o.description)}</td>
            <td class="p-2 border text-center font-semibold">${formattedQuantity}</td>
            <td class="p-2 border">${escapeHtml(o.type)}</td>
        `;
                pdfTableBody.appendChild(tr);
            });

            // üëâ LINHA DOS TOTAIS
            const totalItensRow = document.createElement('tr');
            totalItensRow.innerHTML = `
    <td colspan="4" class="p-2 border font-bold bg-gray-40">
        Total Itens: ${totalItens}
    </td>
`;
            pdfTableBody.appendChild(totalItensRow);

            // üëâ LINHA TOTAL DE QUANTIDADE
            const totalQuantidadeRow = document.createElement('tr');
            totalQuantidadeRow.innerHTML = `
    <td colspan="4" class="p-2 border font-bold bg-gray-40">
        Total Quantidade: ${formatNumberToLocal(totalQuantidade)}
    </td>
`;
            pdfTableBody.appendChild(totalQuantidadeRow);


            // üëâ DATA DO RELAT√ìRIO
            const now = new Date();
            reportDate.textContent = `Data do Relat√≥rio: ${now.toLocaleString('pt-BR')}`;

            const options = {
                margin: [10, 10, 10, 10],
                filename: `Pedidos_GLGA_Historico_${now.getFullYear()}${now.getMonth() + 1}${now.getDate()}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: false, dpi: 192, letterRendering: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            btnExportPDF.disabled = true;
            btnExportPDF.textContent = 'Gerando...';
            pdfContent.classList.remove('hidden');

            html2pdf().from(pdfContent).set(options).save().then(() => {
                pdfContent.classList.add('hidden');
                btnExportPDF.disabled = false;
                btnExportPDF.textContent = 'Exportar PDF (Hist√≥rico)';
                showMsg('PDF do hist√≥rico completo gerado com sucesso.', 'success');
            }).catch(e => {
                console.error("Erro ao gerar PDF:", e);
                btnExportPDF.disabled = false;
                btnExportPDF.textContent = 'Exportar PDF (Hist√≥rico)';
                pdfContent.classList.add('hidden');
                showMsg('Erro ao gerar o PDF. Verifique o console.', 'error');
            });
        }


        // ---------- FINALIZAR PEDIDO (Adicionado valida√ß√£o) ----------
        finalizeOrderBtn.addEventListener('click', () => {
            const dateVal = orderDate.value || new Date().toISOString().split('T')[0];

            // 1. Valida√ß√£o de Data
            if (!dateVal) {
                showMsg('Selecione a Data do Pedido.', 'error');
                orderDate.focus();
                return;
            }

            // 2. Valida√ß√£o de Quantidade (>= 0.01)
            // Filtra itens com quantidade menor ou igual a zero (0.00)
            const invalidCart = cart.filter(item => item.quantity <= 0.009);
            if (invalidCart.length > 0) {
                showMsg(`Aten√ß√£o! Ajuste a quantidade dos seguintes itens (Qtd <= 0): ${invalidCart.map(i => i.description).join(', ')}.`, 'error');
                // Adiciona feedback visual de erro nos inputs
                document.querySelectorAll('.cart-item .qty-input').forEach(input => {
                    const index = parseInt(input.dataset.index);
                    if (cart[index] && cart[index].quantity <= 0.009) {
                        input.classList.add('qty-error');
                    }
                });
                return;
            }

            const validCart = cart.filter(item => item.quantity > 0);

            if (!validCart.length) {
                showMsg('O carrinho est√° vazio. Adicione itens antes de finalizar.', 'error');
                return;
            }

            // 3. REGISTRO
            validCart.forEach(item => {
                orders.unshift({ date: dateVal, description: item.description, quantity: item.quantity, type: item.type || '' });
            });

            saveOrdersToStorage();
            renderOrders();

            // 4. Limpa o carrinho
            cart = [];
            renderCart();
            updateProductIndicators();
            showMsg(`Pedido registrado com sucesso! Total: ${validCart.length} item(ns).`, 'success');
        });

        // ---------- NOVO: Limpar Carrinho ----------
        clearCartBtn.addEventListener('click', () => {
            if (cart.length > 0) {
                if (confirm('Tem certeza que deseja limpar todos os itens do carrinho?')) {
                    cart = [];
                    renderCart();
                    updateProductIndicators();
                    showMsg('Carrinho esvaziado.', 'info');
                }
            } else {
                showMsg('O carrinho j√° est√° vazio.', 'info');
            }
        });

        // ---------- ACIONAMENTO DO PDF ----------
        btnExportPDF.addEventListener('click', generatePDF);


        // ---------- ORDERS STORAGE & RENDER (Mantido) ----------
        function loadOrdersFromStorage() { orders = JSON.parse(localStorage.getItem('orders') || '[]'); renderOrders(); }
        function saveOrdersToStorage() { localStorage.setItem('orders', JSON.stringify(orders)); }

        function renderOrders() {
            const sortedOrders = [...orders];
            if (sortSelect.value === 'old') { sortedOrders.reverse(); }

            ordersContainer.innerHTML = '';
            if (!orders.length) {
                noOrders.classList.remove('hidden');
                countInfo.textContent = '0 pedidos';
                return;
            }
            noOrders.classList.add('hidden');
            const uniqueDates = [...new Set(orders.map(o => o.date))].length;
            countInfo.textContent = `${uniqueDates} pedido(s) (total ${orders.length} itens)`;

            sortedOrders.forEach((o, index) => {
                const formattedQuantity = formatNumberToLocal(o.quantity);

                const card = document.createElement('div');
                card.className = 'flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 p-4 rounded-xl border border-gray-200 bg-white/60';
                card.innerHTML = `
                    <div class="flex-1">
                        <div class="text-sm text-gray-500">Data: <span class="font-medium text-gray-700">${formatDate(o.date)}</span></div>
                        <div class="text-lg font-semibold text-gray-800">${escapeHtml(o.description)}</div>
                        <div class="text-sm text-gray-600">Qtd: <span class="font-medium">${formattedQuantity}</span> ‚Äî Tipo: <span class="font-medium">${escapeHtml(o.type)}</span></div>
                    </div>
                    <div class="flex gap-2 items-center mt-2 sm:mt-0">
                        <button class="viewBtn px-3 py-2 rounded-lg bg-white/70 border border-gray-200">Ver</button>
                        <button class="deleteBtn px-3 py-2 rounded-lg bg-red-600 text-white">Excluir</button>
                    </div>
                `;

                ordersContainer.appendChild(card);

                card.querySelector('.deleteBtn').addEventListener('click', () => {
                    const originalIndex = orders.findIndex(item => item.date === o.date && item.description === o.description && item.quantity === o.quantity && item.type === o.type);
                    if (originalIndex !== -1 && confirm(`Tem certeza que deseja excluir o item: ${o.description} (${formattedQuantity})?`)) {
                        orders.splice(originalIndex, 1);
                        saveOrdersToStorage();
                        renderOrders();
                        showMsg('Item exclu√≠do com sucesso.', 'info');
                    }
                });

                card.querySelector('.viewBtn').addEventListener('click', () => { showDetails(o); });
            });
        }

        sortSelect.addEventListener('change', renderOrders);

        function showDetails(order) {
            const panel = document.getElementById('detailsPanel');
            panel.innerHTML = `
                <div class="flex items-start justify-between gap-4">
                    <div>
                        <h3 class="text-lg font-bold">${escapeHtml(order.description)}</h3>
                        <p class="text-sm text-gray-600">Data: ${formatDate(order.date)}</p>
                        <p class="text-sm text-gray-600">Quantidade: ${formatNumberToLocal(order.quantity)}</p>
                        <p class="text-sm text-gray-600">Tipo: ${escapeHtml(order.type)}</p>
                    </div>
                    <div>
                        <button id="closeDetails" class="px-3 py-2 rounded-lg bg-white/70 border border-gray-200">Fechar</button>
                    </div>
                </div>
            `;
            panel.classList.remove('hidden');
            document.getElementById('closeDetails').addEventListener('click', () => panel.classList.add('hidden'));
            panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }


        // ---------- A√á√ïES GERAIS ----------
        document.getElementById('btnClearAll').addEventListener('click', () => {
            if (!confirm('ATEN√á√ÉO: Deseja realmente limpar TODOS os pedidos registrados no seu dispositivo?')) return;
            orders = [];
            saveOrdersToStorage();
            renderOrders();
            showMsg('Todos os pedidos registrados foram exclu√≠dos.', 'error');
        });


        // ---------- INICIALIZA√á√ÉO ----------
        document.addEventListener('DOMContentLoaded', () => {
            loadOrdersFromStorage();
            fetchProducts();
            renderCart();
        });
    </script>
</body>

</html>
